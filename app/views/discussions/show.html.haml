= render 'canoes/canoe_header'

.bs-component
  .container
    .clearfix
      .pull-right
        = user_byline @discussion.user
        %i.fa.fa-clock-o
        = date_f @discussion.created_at
        - if can? :update, @discussion
          = link_to [:edit, @discussion] do
            %i.fa.fa-edit
        - if can? :destroy, @discussion
          = link_to @discussion, method: :delete, data: { confirm: '정말 삭제하시겠습니까?'} do
            %i.fa.fa-trash
    %h2.text-center(style='margin-bottom:50px;')
      #{@discussion.subject}

    %h4
      %i.fa.fa-thumb-tack
      현재 결정 사항
      - if can? :update, @discussion
        %button.btn-link(role="button" data-toggle="canoe-toggle" data-parent="#discussion-decision" data-focus="#discussion_decision")
          %i.fa.fa-edit
      %button.btn-link
        = render partial: 'attachments/button', locals: { attachable: @discussion }

    = render 'decision'

    %h4
      %i.fa.fa-rocket
      제안
    #proposals.clearfix(style='margin: 20px 0;')
      - if @discussion.proposals.any?
        %ul.list-group
          - [@discussion.proposals.top_of(:in_favor).latest, @discussion.proposals.exclude_top_of(:in_favor).latest].flatten.each do |proposals|
            = render proposals
      - else
        .canoe-toggle-item
          %strong
            아직 제안이 없습니다.
      - if can? :update, @discussion
        .canoe-toggle-item.pull-right
          %button.btn.btn-default.btn-block(role="button" data-toggle="canoe-toggle" href="#proposals-form" data-parent="#proposals" data-focus="#proposal_body")
            제안 작성하기 >>
        .canoe-toggle-item.hidden
          = form_for [@discussion, @discussion.proposals.build] do |f|
            .form-group
              = f.text_area :body, autofocus: true, class: 'form-control', style: "width: 100%; height: 60px;", placeholder: '내 제안은...'
            .form-group.pull-right
              = f.submit '제안올리기', class: 'btn btn-primary'
            .form-group.pull-right
              .btn-file(style='line-height: 40px; margin-right: 20px;')
                = f.fields_for 'attachments_attributes[]', f.object.attachments.build do |f_attachment|
                  = f_attachment.file_field :source, data: {list: '#proposals-files'}
                %i.fa.fa-upload
          %button.btn.btn-default(role="button" data-toggle="canoe-toggle" href="#proposals-static" data-parent="#proposals") << 닫기
          .clearfix
          %ul#proposals-files.list-inline
.bs-component(style='background-color: #efefef; padding-top: 50px; padding-bottom: 50px; margin-bottom: 50px; margin-top: 20px;')
  .container
    %h4
      %i.fa.fa-comments
      의견
    %ul.media-list
      - if can? :update, @discussion
        %li.media
          .media-left
            %a{:href => "#"}
              = image_tag current_user.image_url, class: 'media-object img-circle', style: 'width:64px;height:64px;'
          .media-body
            = form_for [@discussion, Opinion.new] do |f|
              .form-group
                = f.text_area :body, class: 'form-control', style: "width: 100%; height: 100px;", placeholder: '내 의견은...'
              .form-group.pull-right
                = f.submit '의견올리기', class: 'btn btn-default'
              .form-group.pull-right
                .btn-file(style='line-height: 40px; margin-right: 20px;')
                  = f.fields_for 'attachments_attributes[]', f.object.attachments.build do |f_attachment|
                    = f_attachment.file_field :source, data: {list: '#opinions-files'}
                  %i.fa.fa-upload
            .clearfix
            %ul#opinions-files.list-inline
      = render partial: 'public_activity/collection', locals: { activities: @discussion.activities.order(created_at: :desc) }

    %hr

.bs-component
  .container
    .panel.panel-default
      .panel-heading
        %h4.text-muted
          %i.fa.fa-flag
          논의
          - if can?(:update, @canoe)
            %small.pull-right
              = link_to new_canoe_discussion_path(@canoe), class: 'btn btn-xs btn-success' do
                %i.fa.fa-edit
                논의 시작하기
      %table.table
        %tbody
          = render @canoe.discussions.order("updated_at DESC")
